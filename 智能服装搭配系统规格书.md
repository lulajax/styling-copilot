# 智能服装搭配系统规格书

## 文档元信息
- 版本: `v1.2`
- 状态: `Engineering Baseline Frozen`
- 适用范围: 团播业务中的主播信息管理、服装库存管理、AI 搭配生成、历史记录与复盘分析
- 最后更新日期: `2026-02-09`

## 术语与角色定义
- 团播团队: 使用系统进行搭配决策与复盘的业务组织。
- 搭配师: 在系统内发起搭配任务、筛选候选方案的业务角色。
- 主播: 被搭配对象，具备身材数据、风格标签和历史表现数据。
- 服装: 进入搭配池的库存单品，状态包含 `ON_SHELF` 与 `OFF_SHELF`。
- 搭配任务: 一次完整的推荐生成流程，状态使用 `TaskStatus` 表示。

## 1. 项目概述
### 1.1 目的
构建面向团播团队的智能服装搭配 SaaS，提升人货匹配效率，提供可追踪、可复盘的 AI 辅助搭配能力。

### 1.2 约束
- AI 结果必须结合主播画像、服装库存和近期历史记录。
- 业务侧可接受 AI 建议，不允许 AI 直接覆盖人工决策。
- 搭配结果需支持审计与回溯。

### 1.3 实现要点
- 使用规则 + AI 混合策略支持冷启动与稳定期。
- 通过 SSE 返回任务过程状态，避免长轮询。
- 保留搭配记录与 performance 数据用于后续优化。

### 1.4 关键指标（可验证）
| 指标 | 目标值 | 测量方式 | 采样窗口 |
| :--- | :--- | :--- | :--- |
| AI 生成响应时延 | `< 30s` | `POST /api/match/tasks` 到任务 `SUCCEEDED` 的端到端耗时 | 近 7 天 p95 |
| 首屏加载时间 | `< 1s` | Web Vitals `LCP`（工作台首页） | 近 7 天 p75 |
| 图片加载耗时 | `< 200ms` | CDN 命中情况下图片请求耗时 | 近 7 天 p95 |
| SSE 重连最大退避 | `<= 30s` | 断连后自动重连日志 | 近 7 天 |

## 2. 技术栈与版本
### 2.1 目的
统一前后端与基础设施基线，控制工程复杂度与运维成本。

### 2.2 约束
- 前后端需支持 TypeScript + Java 双栈协作。
- 组件与框架版本需使用 LTS 或稳定主线。
- AI 提供商需支持内容安全配置与可观测失败原因。

### 2.3 实现要点
#### 前端（Client）
- Runtime: `Node.js 20+`
- Framework: `Vue 3.4+`（Composition API，`<script setup>`，TypeScript 5.3）
- State: `Pinia 2.1+`
- UI: `Element Plus`（按需加载 + 自定义主题）
- Network: `Axios`（REST），`event-source-polyfill`（SSE 兼容）
- Build: `Vite 5+`
- Test: `Vitest`（单测），`Cypress`（E2E 可选）

#### 后端（Server）
- Runtime: `JDK 21`
- Framework: `Spring Boot 3.2.x`
- ORM: `Spring Data JPA (Hibernate 6.x)`
- Database: `MySQL 8.0+ (InnoDB)`
- Cache: `Caffeine`（本地缓存），`Redis`（可选限流）
- Auth: `JJWT 0.12+`
- Tools: `MapStruct`、`Lombok`、`Bucket4j`

#### 基础设施
- Storage: 阿里云 `OSS`（开启 CDN）
- AI: `Google Gemini 3 Pro`（Vertex AI / Studio API）
- Server: 阿里云 `ECS Ubuntu 22.04` + `Nginx`

## 3. 项目结构规范
### 3.1 目的
通过固定目录分层降低模块耦合，保证职责清晰和可维护性。

### 3.2 约束
- 后端按业务模块分包，禁止跨层直接调用持久层。
- 前端按页面、业务组件、组合式函数分域组织。
- 公共能力仅在 `common/` 与 `utils/` 暴露。

### 3.3 实现要点
#### 后端结构（Maven）
```text
src/main/java/com/company/fashion/
├── common/
│   ├── api/            # Result<T>, ErrorCode
│   ├── exception/      # GlobalExceptionHandler
│   └── util/           # SecurityUtils, ImageUtils
├── config/             # CORS, Swagger, Async, RateLimit
├── modules/
│   ├── auth/
│   ├── member/
│   │   ├── controller/
│   │   ├── entity/
│   │   ├── repository/
│   │   └── service/
│   ├── clothing/
│   └── match/
│       ├── ai/         # GeminiService, PromptBuilder
│       ├── sse/        # SseService
│       └── strategy/   # Rule/AI RecommendationStrategy
└── FashionApplication.java
```

#### 前端结构（Vue3）
```text
src/
├── api/
├── assets/
├── components/
│   ├── common/
│   └── business/
├── composables/
├── layout/
├── router/
├── stores/
├── types/
├── utils/
└── views/
    ├── dashboard/
    ├── match-studio/
    └── history/
```

## 4. 代码与命名规范
### 4.1 目的
统一编码风格，保证跨团队可读性和审查效率。

### 4.2 约束
- Java 类名 `PascalCase`，方法与变量 `camelCase`。
- DTO 统一命名后缀: `*Request`、`*Response`。
- Entity 禁止 `@Data`，使用 `@Getter @Setter @ToString`。
- Controller 返回统一 `Result<T>`。
- Vue 组件采用多单词命名，文件名与组件名一致。
- Props 必须声明类型与默认值。

### 4.3 实现要点
- 复杂业务逻辑（排重、冷启动、重试）必须补充 Javadoc 或等价注释。
- 样式命名使用 BEM 或 Scoped CSS，不允许混乱全局覆盖。
- 错误码、状态码、枚举集中维护，避免前后端定义漂移。

## 5. 关键业务策略与实现细节
### 5.1 目的
固定关键业务规则，防止策略实现偏离。

### 5.2 约束
- 历史排重必须覆盖数据库层和应用层双重校验。
- 冷启动逻辑必须可回退到规则策略，不依赖历史记录。
- 安全与异常处理为强制能力，不能按模块选择性实现。

### 5.3 实现要点
#### 历史排重与冷启动
1. 查询历史: `matchRecordRepository.findTop10ByMemberIdOrderByScoreDesc(memberId)`。
2. 排重规则:
   - SQL 层过滤: `broadcast_date > :sevenDaysAgo`
   - 代码层过滤: Stream 二次校验，避免缓存或并发导致漏过滤。
3. 冷启动:
   - 当 `history.size() < 3` 时切换 Rule-Based 策略。
   - Prompt 移除 `<history_context>`，替换为 `<style_guide>`。

#### 图片性能优化
- 上传限制 `<= 5MB`，压缩到最大边 `1600`。
- OSS 参数:
  - 列表页: `?x-oss-process=image/resize,w_200`
  - 详情页: `?x-oss-process=image/resize,w_800/quality,q_80`
- 前端图片懒加载统一封装，避免页面重复实现。

#### 错误处理与重试
- AI 调用重试: `@Retryable(maxAttempts = 3, backoff = @Backoff(delay = 2000))`。
- SSE 自动重连: 指数退避，最大退避 `30s`。
- 全局异常处理必须覆盖:
  - `OptimisticLockingFailureException`
  - `AiSafetyException`

#### 安全与鉴权
- `Access Token` 有效期: `30 分钟`
- `Refresh Token` 有效期: `7 天`
- 刷新流程: Axios 拦截 `401` -> `/api/auth/refresh` -> 重试原请求。
- 内容安全策略: `HARM_CATEGORY_SEXUALLY_EXPLICIT + BLOCK_ONLY_HIGH`。

#### 边缘场景
- 软删除:
  - `@SQLDelete(sql = "UPDATE table SET deleted = true WHERE id = ?")`
  - `@Where(clause = "deleted = false")`
  - 已软删除主播历史记录保留分析用途，不允许发起新任务。
- 服装下架:
  - `Clothing.status = OFF_SHELF` 后不进入新任务候选集。
  - 已存在历史记录仍可查询。

## 6. 测试策略
### 6.1 目的
保证关键业务规则和稳定性指标可验证、可回归。

### 6.2 约束
- Service 层单测覆盖率 `> 80%`。
- Controller 集成测试覆盖率 `> 60%`。
- 所有核心链路测试必须包含鉴权与异常断言。

### 6.3 实现要点
#### 必测用例
1. 排重测试
   - 前置: 插入一条 3 天前搭配记录。
   - 操作: 发起同主播同服装搭配任务。
   - 预期: `clothing_id` 被过滤或返回重复提示。
2. SSE 稳定性测试
   - 操作: 模拟 AI 任务耗时 40 秒。
   - 预期: Nginx 不断连，前端保持 loading 并接收完成事件。
3. 并发限流测试
   - 操作: 同一搭配师并发发起 5 个任务。
   - 预期: Bucket4j 触发限流，返回 `429` 或进入排队分支。

## 7. 数据库设计（DDL 规范）
### 7.1 目的
定义最小可落地数据模型，支撑排重、追踪与分析。

### 7.2 约束
- 主业务表需包含软删除字段与必要索引。
- `match_record` 必须可按主播、分值、时间维度查询。
- DDL 为规范基线，实际生产变更由迁移脚本管理。

### 7.3 实现要点
```sql
CREATE TABLE `member` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `created_at` datetime(6) NOT NULL,
  `updated_at` datetime(6) DEFAULT NULL,
  `deleted` bit(1) NOT NULL DEFAULT 0,
  `body_data` json DEFAULT NULL,
  `name` varchar(255) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_deleted` (`deleted`)
) ENGINE=InnoDB;

CREATE TABLE `match_record` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `member_id` bigint NOT NULL,
  `clothing_id` bigint NOT NULL,
  `broadcast_date` datetime(6) DEFAULT NULL,
  `status` enum('DRAFT','ACCEPTED','BROADCASTED','REJECTED') NOT NULL,
  `performance_score` int DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_member_score` (`member_id`, `performance_score`),
  KEY `idx_broadcast_date` (`broadcast_date`)
) ENGINE=InnoDB;
```

## 8. 核心接口与数据契约
### 8.1 目的
给出研发可直接对齐的关键接口与数据结构，避免跨端歧义。

### 8.2 约束
- 仅定义核心接口，不替代全量 OpenAPI。
- 所有接口响应遵循统一 `Result<T>` 包装。
- 状态码与错误码需稳定，便于前端统一处理。

### 8.3 公共类型约束
- DTO 命名统一后缀: `*Request`、`*Response`。
- 关键字段命名固定: `memberId`、`clothingIds`、`taskId`、`score`。
- 任务状态枚举:

```text
TaskStatus = QUEUED | RUNNING | SUCCEEDED | FAILED
```

### 8.4 接口清单
#### 1) `POST /api/auth/login`
- 用途: 用户登录并获取访问令牌。
- 鉴权: 否。
- 请求字段:
  - `username: string`
  - `password: string`
- 响应字段:
  - `accessToken: string`
  - `refreshToken: string`
  - `expiresIn: number`
- 错误码: `400`、`401`、`500`。

#### 2) `POST /api/auth/refresh`
- 用途: 刷新 Access Token。
- 鉴权: 否（使用 Refresh Token）。
- 请求字段:
  - `refreshToken: string`
- 响应字段:
  - `accessToken: string`
  - `expiresIn: number`
- 错误码: `400`、`401`、`500`。

#### 3) `POST /api/match/tasks`
- 用途: 发起搭配任务。
- 鉴权: 是（Bearer Token）。
- 请求字段:
  - `memberId: number`
  - `clothingIds: number[]`
  - `scene: string`（可选）
- 响应字段:
  - `taskId: string`
  - `status: TaskStatus`（初始为 `QUEUED`）
- 错误码: `400`、`401`、`429`、`500`。

#### 4) `GET /api/match/tasks/{taskId}`
- 用途: 查询任务状态和结果摘要。
- 鉴权: 是。
- 路径参数:
  - `taskId: string`
- 响应字段:
  - `taskId: string`
  - `status: TaskStatus`
  - `result: MatchTaskResponse | null`
  - `errorMessage: string | null`
- 错误码: `400`、`401`、`500`。

#### 5) `GET /api/match/tasks/{taskId}/events`（SSE）
- 用途: 订阅任务进度事件流。
- 鉴权: 是。
- 路径参数:
  - `taskId: string`
- 事件类型:
  - `task_started`
  - `task_progress`
  - `task_completed`
  - `task_failed`
- 错误码: `401`、`429`、`500`。

#### 6) `GET /api/members/{memberId}/history`
- 用途: 查询主播历史搭配记录用于排重与复盘。
- 鉴权: 是。
- 路径参数:
  - `memberId: number`
- 查询参数:
  - `limit: number`（默认 `10`）
- 响应字段:
  - `records: MatchHistoryItemResponse[]`
  - `total: number`
- 错误码: `400`、`401`、`500`。

#### 7) `GET /api/clothing?status=ON_SHELF`
- 用途: 查询上架服装池。
- 鉴权: 是。
- 查询参数:
  - `status: string`（固定 `ON_SHELF`）
  - `page: number`
  - `size: number`
- 响应字段:
  - `items: ClothingItemResponse[]`
  - `total: number`
- 错误码: `400`、`401`、`500`。

## 9. 模块化验收标准
### 9.1 目的
将系统能力拆分为可执行、可判定的模块验收项。

### 9.2 约束
- 每个模块必须包含前置条件、操作步骤、预期结果、失败判定。
- 验收点需覆盖性能、稳定性、鉴权、业务规则。

### 9.3 验收项
#### 模块 A: 认证
- 前置条件: 已创建有效账号。
- 操作步骤: 调用登录接口，使用刷新接口续期，再调用受保护接口。
- 预期结果: 登录成功返回 token；refresh 后原会话可继续访问。
- 失败判定: 出现无效 token 仍可访问，或 refresh 后 token 不可用。

#### 模块 B: 主播管理
- 前置条件: 存在可编辑主播记录。
- 操作步骤: 更新主播资料并触发搭配任务。
- 预期结果: 新任务读取到更新后的 `body_data` 和风格标签。
- 失败判定: 数据已更新但任务仍读取旧画像。

#### 模块 C: 服装库存
- 前置条件: 同时存在 `ON_SHELF` 与 `OFF_SHELF` 服装。
- 操作步骤: 查询库存列表并发起搭配任务。
- 预期结果: 新任务只使用 `ON_SHELF`，历史记录可展示已下架服装。
- 失败判定: `OFF_SHELF` 出现在新任务候选集中。

#### 模块 D: 搭配任务
- 前置条件: 主播与库存数据完整。
- 操作步骤: 发起任务并轮询状态到完成。
- 预期结果: 任务状态流转 `QUEUED -> RUNNING -> SUCCEEDED/FAILED`，成功任务端到端耗时 `<30s`（p95）。
- 失败判定: 状态跳变异常、超时无终态、超出性能阈值。

#### 模块 E: SSE 推送
- 前置条件: 可用任务 `taskId`，网络可模拟断连。
- 操作步骤: 订阅 `/events`，在处理中模拟断网并恢复。
- 预期结果: 客户端自动重连，指数退避最大 `30s`，最终收到终态事件。
- 失败判定: 断连后无法恢复订阅，或退避超出 `30s`。

#### 模块 F: 历史排重
- 前置条件: `match_record` 中存在 7 天内重复候选服装记录。
- 操作步骤: 发起新任务并观察候选过滤。
- 预期结果: 重复 `clothing_id` 被过滤；`performance_score` 可用于历史优先级排序。
- 失败判定: 7 天内重复服装未过滤，或排序不按 `performance_score` 生效。

#### 模块 G: 并发与限流
- 前置条件: 同一用户可并发发起任务。
- 操作步骤: 在 1 秒内连续提交 5 个任务请求。
- 预期结果: 限流生效，超限请求返回 `429` 或进入明确排队策略。
- 失败判定: 超限请求无控制进入执行，导致资源争用。

## 10. 文档维护说明
- 本文档为工程实施基线，任何接口、状态枚举、鉴权时效变更必须同步更新本文件。
- 触发更新条件:
  - 新增/删除核心接口。
  - 调整 `TaskStatus`、错误码或令牌时效。
  - 业务策略调整（排重窗口、冷启动阈值、限流规则）。
- 更新流程:
  - 方案评审通过后更新文档。
  - 合并代码前完成文档一致性复核。
  - 发布后记录版本与日期。

## 11. 环境、发布与回滚
### 11.1 目的
约束从开发到生产的发布过程，保证版本可回溯、可回滚、可审计。

### 11.2 约束
- 三套环境必须隔离: `dev`、`staging`、`prod`。
- 数据库变更必须通过迁移脚本执行（`Flyway` 或 `Liquibase`），禁止手工改表。
- 生产发布采用灰度或分批放量，不允许一次性全量切换。

### 11.3 实现要点
1. CI 流程（每次 PR）:
   - 执行后端单测、前端单测、静态检查。
   - 构建镜像并生成版本号（建议 `yyyyMMdd-HHmm-commitSha`）。
2. CD 流程（合并到主干）:
   - 自动部署 `staging`，完成冒烟后由人工触发 `prod`。
   - 生产先放量 10%，观察 30 分钟后再全量。
3. 回滚策略:
   - 应用层: 回滚到上一稳定镜像版本。
   - 数据层: 仅允许前向修复；如需回滚必须有对应回退脚本并经评审。

## 12. 可观测性与告警
### 12.1 目的
确保任务链路可诊断，出现性能下降或失败激增时可快速定位。

### 12.2 约束
- 每个搭配任务必须有全链路 `traceId`。
- 关键事件日志必须结构化（JSON），禁止纯文本拼接日志。
- 告警必须覆盖可用性、性能、错误率三类指标。

### 12.3 实现要点
- 指标（Prometheus）:
  - `match_task_latency_seconds`（P50/P95/P99）
  - `match_task_failed_total`
  - `sse_reconnect_total`
  - `ai_request_retry_total`
- 日志关键字段:
  - `traceId`、`taskId`、`memberId`、`operatorId`、`status`、`errorCode`
- 告警阈值:
  - 5 分钟失败率 `> 5%` 触发 P2
  - 15 分钟 P95 延迟 `> 30s` 触发 P2
  - SSE 重连失败率 `> 2%` 触发 P3

## 13. 数据治理与合规
### 13.1 目的
明确个人信息、业务数据的处理边界，满足最小化采集和可追踪要求。

### 13.2 约束
- 主播可识别信息必须分级存储，敏感字段加密或脱敏展示。
- `body_data` 仅用于搭配与复盘，禁止外部二次用途。
- 所有导出行为必须记录操作人、时间、导出范围。

### 13.3 实现要点
- 数据分级:
  - `L1` 公开业务字段（服装基础信息）
  - `L2` 内部业务字段（任务结果、评分）
  - `L3` 敏感字段（主播体型细节、联系方式）
- 保留策略:
  - 搭配任务明细: 保留 `365` 天
  - 操作审计日志: 保留 `180` 天
  - 训练与优化样本: 脱敏后保留 `365` 天
- 权限策略:
  - 搭配师默认可读业务结果，不可导出 L3 数据
  - 管理员导出需二次确认与审计落库

## 14. 实施里程碑与交付清单
### 14.1 里程碑计划（建议）
1. M1（第 1-2 周）: 完成认证、主播管理、服装库存基础 CRUD 与鉴权打通。
2. M2（第 3-4 周）: 完成搭配任务编排、规则策略、SSE 推送、历史排重。
3. M3（第 5-6 周）: 接入 Gemini、异常重试、监控告警、性能压测与验收。
4. M4（第 7 周）: 灰度上线、复盘优化、冻结 `v1.2` 基线。

### 14.2 每阶段交付物
- 可运行代码与部署产物（镜像、环境变量模板）。
- 接口契约（OpenAPI 导出）与变更记录。
- 测试报告（功能、性能、稳定性）与已知问题清单。
- 运维手册（发布、回滚、告警处理）。

## 15. 风险与待决策项（RAID）
| 类型 | 项目 | 影响 | 当前策略 | 截止日期 |
| :--- | :--- | :--- | :--- | :--- |
| Risk | AI 输出波动导致方案不稳定 | 搭配师信任度下降 | 增加规则兜底与人工确认 | 2026-02-20 |
| Risk | 高峰期并发导致任务积压 | 响应超时 | 限流 + 排队 + 热点缓存 | 2026-02-20 |
| Assumption | 服装素材质量满足建模要求 | 推荐质量受输入质量影响 | 建立图片入库校验规范 | 2026-02-18 |
| Issue | 旧历史数据字段不完整 | 冷启动准确率下降 | 首次上线阶段启用规则策略优先 | 2026-02-16 |
| Decision | 是否引入多 AI 提供商容灾 | 稳定性与成本权衡 | 先单供应商，M3 后评估双活 | 2026-02-25 |
